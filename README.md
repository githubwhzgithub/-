# STM32 平衡车控制系统

## 项目概述

这是一个基于STM32F103C8T6微控制器的自平衡车控制系统。系统集成了多个传感器和执行器，实现了完整的平衡控制、障碍物检测、蓝牙通信等功能。

## 硬件配置

### 主控制器
- **MCU**: STM32F103C8T6
- **时钟**: 72MHz系统时钟
- **Flash**: 64KB
- **RAM**: 20KB

### 硬件模块及引脚分配

#### 1. TB6612电机驱动模块
- **PWMA**: PB14 (TIM1_CH2N) - 电机A的PWM控制
- **PWMB**: PB15 (TIM1_CH3N) - 电机B的PWM控制
- **AIN1**: PB12 - 电机A方向控制1
- **AIN2**: PB13 - 电机A方向控制2
- **BIN1**: PB14 - 电机B方向控制1
- **BIN2**: PB15 - 电机B方向控制2

#### 2. 电机编码器
- **编码器A**: TIM1_CH1 (PA8), TIM1_CH2 (PA9)
- **编码器B**: TIM2_CH1 (PA0), TIM2_CH2 (PA1)
- **分辨率**: 每转1440脉冲 (360线×4倍频)
- **减速比**: 1:30

#### 3. MPU6050姿态传感器
- **SDA**: PB7 (I2C1_SDA)
- **SCL**: PB6 (I2C1_SCL)
- **功能**: 3轴加速度计 + 3轴陀螺仪
- **滤波**: 卡尔曼滤波算法

#### 4. HC-SR04超声波测距
- **TRIG**: PA12 - 触发引脚
- **ECHO**: PA11 - 回响引脚 (外部中断)
- **测距范围**: 2cm - 400cm
- **精度**: ±3mm

#### 5. HC-05蓝牙通信
- **BT_TX**: PB10 (USART3_TX)
- **BT_RX**: PB11 (USART3_RX)
- **波特率**: 9600bps
- **功能**: 远程控制和状态监控

#### 6. 摄像头串口 (预留)
- **CAM_TX**: PA2 (USART2_TX)
- **CAM_RX**: PA3 (USART2_RX)
- **波特率**: 115200bps
- **功能**: 摄像头通信接口 (暂未使用)

## 软件架构

### 模块化设计

```
├── Core/
│   ├── Inc/
│   │   ├── TB6612.h           # 电机驱动模块
│   │   ├── motorencoder.h     # 编码器模块
│   │   ├── ultrasonic.h       # 超声波模块
│   │   ├── balance_control.h  # 平衡控制模块
│   │   ├── bluetooth.h        # 蓝牙通信模块
│   │   └── mpu6050.h         # MPU6050传感器模块
│   └── Src/
│       ├── TB6612.c
│       ├── motorencoder.c
│       ├── ultrasonic.c
│       ├── balance_control.c
│       ├── bluetooth.c
│       ├── mpu6050.c
│       └── main.c            # 主程序
```

### 控制算法

#### 1. 平衡控制
- **角度环PID**: 控制车体倾斜角度
  - Kp = 100.0, Ki = 0.1, Kd = 10.0
- **速度环PID**: 控制前进后退速度
  - Kp = 50.0, Ki = 0.05, Kd = 5.0
- **转向PID**: 控制左右转向
  - Kp = 30.0, Ki = 0.02, Kd = 3.0

#### 2. 卡尔曼滤波
- 融合加速度计和陀螺仪数据
- 实时估计车体姿态角度
- 滤除传感器噪声

#### 3. 障碍物避障
- 检测距离 < 20cm时触发避障
- 自动后退并停止前进

### 任务调度

| 任务 | 频率 | 功能 |
|------|------|------|
| 平衡控制 | 200Hz (5ms) | PID控制算法执行 |
| 编码器更新 | 100Hz (10ms) | 读取编码器数据 |
| 蓝牙通信 | 50Hz (20ms) | 处理蓝牙命令 |
| 超声波测距 | 20Hz (50ms) | 距离测量 |
| 状态输出 | 1Hz (1000ms) | 调试信息输出 |

## 蓝牙控制命令

### 基本控制命令
- `START` - 启动平衡控制
- `STOP` - 停止平衡控制
- `FORWARD [speed]` - 前进 (可选速度参数)
- `BACKWARD [speed]` - 后退 (可选速度参数)
- `LEFT` - 左转
- `RIGHT` - 右转
- `RESET` - 系统重置

### 参数设置命令
- `SPEED <value>` - 设置目标速度 (-1.0 ~ 1.0)
- `ANGLE <value>` - 设置目标角度 (-30° ~ 30°)
- `PID <Kp> <Ki> <Kd>` - 设置角度环PID参数

### 状态查询命令
- `STATUS` - 获取当前系统状态

### 命令示例
```
START              # 启动平衡
FORWARD 0.3        # 以0.3的速度前进
SPEED 0.5          # 设置速度为0.5
PID 120.0 0.2 15.0 # 设置PID参数
STATUS             # 查询状态
STOP               # 停止平衡
```

## 编译和烧录

### 开发环境
- **IDE**: STM32CubeIDE & Keil MDK
- **HAL库**: STM32F1xx HAL Driver
- **编译器**: ARM GCC

### 编译步骤
1. 打开项目文件
2. 配置编译器路径
3. 编译项目 (Build Project)
4. 生成.hex或.bin文件

### 烧录方式
- **ST-Link**: 使用ST-Link V2调试器
- **串口**: 使用UART线连接到开发板

## 调试和测试

### 串口调试
连接USART3 (PB10/PB11) 到USB转串口模块：
- 波特率: 115200
- 数据位: 8
- 停止位: 1
- 校验位: 无

### 调试信息
系统会定期输出以下调试信息：
```
[DEBUG] Pitch:1.23 Roll:-0.45 Speed:0.12 Dist:25.3cm Enable:1
```

### 蓝牙调试
使用蓝牙串口助手连接HC-05模块：
- 配对密码: 1234
- 波特率: 9600
- 发送命令测试各项功能

## 安全注意事项

1. **电源管理**
   - 使用12V锂电池供电

2. **机械安全**
   - 确保车轮与地面良好接触
   - 检查电机和车架固定
   - 避免在高处测试

## 故障排除

### 常见问题

1. **平衡车不能站立**
   - 检查MPU6050连接
   - 调整PID参数
   - 确认电机方向正确

2. **蓝牙无法连接**
   - 检查HC-05模块电源
   - 确认波特率设置
   - 重新配对设备

3. **编码器读数异常**
   - 检查编码器供电
   - 确认信号线连接
   - 检查定时器配置

4. **超声波测距不准**
   - 检查TRIG/ECHO连接
   - 确认中断配置
   - 避免声波干扰

### 调试步骤
1. 检查硬件连接
2. 验证各模块初始化
3. 单独测试各个模块
4. 检查串口输出信息
5. 使用示波器检查信号

## 扩展功能

### 可添加的功能
1. **WiFi通信**: 替换蓝牙模块
2. **摄像头**: 添加图像识别
3. **语音控制**: 集成语音识别模块
4. **路径规划**: 实现自主导航
5. **多传感器融合**: 添加更多传感器

### 性能优化
1. **算法优化**: 使用更高级的控制算法
2. **实时性**: 使用RTOS提高实时性
3. **功耗优化**: 添加低功耗模式
4. **稳定性**: 改进机械结构

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

---

**注意**: 本项目仅供学习和研究使用，请确保在安全的环境中进行测试。
